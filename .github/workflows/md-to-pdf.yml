name: MD to PDF

on:
  push:
    branches:
      - main
    paths:
      - '**/*.md'
  workflow_dispatch:

jobs:
  md-to-pdf:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install markdown weasyprint

      - name: Convert changed MD files to PDF
        run: |
          python3 << 'EOF'
          import os
          import subprocess
          from markdown import markdown
          from weasyprint import HTML

          # Get changed markdown files
          try:
              result = subprocess.run(
                  ['git', 'diff', '--name-only', 'HEAD^', 'HEAD', '--', '*.md', ':!README.md'],
                  capture_output=True,
                  text=True,
                  check=True
              )
              changed_files = result.stdout.strip().split('\n')
          except subprocess.CalledProcessError:
              # Fallback for manual runs or first commit
              result = subprocess.run(
                  ['git', 'ls-files', '*.md', ':!README.md'],
                  capture_output=True,
                  text=True,
                  check=True
              )
              changed_files = result.stdout.strip().split('\n')

          changed_files = [f for f in changed_files if f and os.path.isfile(f)]

          if not changed_files:
              print("No markdown files to process.")
              exit(0)

          print(f"Converting {len(changed_files)} file(s):")
          for md_file in changed_files:
              print(f"  - {md_file}")
              pdf_file = md_file.replace('.md', '.pdf')
              
              # Read markdown and convert to HTML
              with open(md_file, 'r', encoding='utf-8') as f:
                  md_content = f.read()
              
              html_content = markdown(md_content, extensions=['tables', 'fenced_code'])
              
              # Add basic styling
              styled_html = f"""
              <html>
              <head>
                  <style>
                      body {{ font-family: Arial, sans-serif; margin: 40px; }}
                      code {{ background-color: #f4f4f4; padding: 2px 4px; }}
                      pre {{ background-color: #f4f4f4; padding: 10px; }}
                      table {{ border-collapse: collapse; width: 100%; }}
                      th, td {{ border: 1px solid #ddd; padding: 8px; text-align: left; }}
                  </style>
              </head>
              <body>
                  {html_content}
              </body>
              </html>
              """
              
              # Convert to PDF
              HTML(string=styled_html).write_pdf(pdf_file)
              print(f"âœ“ Created {pdf_file}")
          EOF

      - name: Commit PDFs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add '*.pdf'

          if git diff --cached --quiet; then
            echo "No PDF changes to commit."
            exit 0
          fi

          git commit -m "Auto-generate PDFs from markdown"
          git push

name: Convert changed Markdown to PDF

on:
  push:
    branches:
      - main
    paths:
      - '**/*.md'
    paths-ignore:
      - '**/README.md'

permissions:
  contents: write

jobs:
  md-to-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-latex-recommended

      - name: Find changed markdown files
        id: changed
        run: |
          # Determine changed files between the pushed commit and the previous commit
          BEFORE=${{ github.event.before }}
          AFTER=${{ github.sha }}
          # If this is the first commit in the repo, fallback to listing all md files
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            git ls-files '*.md' > changed_md.txt || true
          else
            git diff --name-only "$BEFORE" "$AFTER" -- '*.md' > changed_md.txt || true
          fi
          # Exclude README.md anywhere in the repo
          grep -v -E '(^|/)(README|readme)\.md$' changed_md.txt > changed_md_filtered.txt || true
          echo "::set-output name=files::$(cat changed_md_filtered.txt | tr '\n' '|' )"

      - name: Convert changed markdown to PDF and stage differences
        if: steps.changed.outputs.files != ''
        run: |
          set -euo pipefail
          IFS='|' read -r -a FILES <<< "${{ steps.changed.outputs.files }}"
          CHANGED=false
          for f in "${FILES[@]}"; do
            if [ -z "$f" ]; then
              continue
            fi
            # Ensure directory exists for output
            out="${f%.md}.pdf"
            outdir=$(dirname "$out")
            mkdir -p "$outdir"

            # Convert using pandoc with xelatex for better font handling
            pandoc "$f" -o "$out" --pdf-engine=xelatex || {
              echo "pandoc failed for $f"
              exit 1
            }

            # If PDF does not exist in git or differs, stage it
            if ! git ls-files --error-unmatch "$out" >/dev/null 2>&1; then
              echo "New PDF created: $out"
              git add "$out"
              CHANGED=true
            else
              # Compare binary files; if different, stage
              if ! git diff --no-index --quiet "$out" "$out"; then
                # The above is a no-op comparison placeholder; use cmp to compare working file with HEAD version
                git show HEAD:"$out" >/tmp/old.pdf || true
                if ! cmp -s /tmp/old.pdf "$out"; then
                  echo "PDF changed: $out"
                  git add "$out"
                  CHANGED=true
                fi
                rm -f /tmp/old.pdf
              fi
            fi
          done

          if [ "$CHANGED" = "true" ]; then
            git commit -m "chore: update PDFs generated from changed markdown files" || echo "nothing to commit"
            git push origin HEAD:main
          else
            echo "No PDF changes to commit"
          fi

      - name: No changed markdown files
        if: steps.changed.outputs.files == ''
        run: echo "No changed markdown files to process"

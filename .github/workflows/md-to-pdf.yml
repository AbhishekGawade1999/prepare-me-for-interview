name: MD to PDF

on:
  push:
    branches:
      - main
    paths:
      - '**/*.md'
  workflow_dispatch:

jobs:
  md-to-pdf:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Pandoc and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-latex-extra
          pip install pandoc-link-filter

      - name: Convert changed MD files to PDF
        run: |
          python3 << 'EOF'
          import os
          import subprocess
          import re

          # Get changed markdown files
          try:
              result = subprocess.run(
                  ['git', 'diff', '--name-only', 'HEAD^', 'HEAD', '--', '*.md', ':!README.md'],
                  capture_output=True, text=True, check=True
              )
              changed_files = result.stdout.strip().split('\n')
          except subprocess.CalledProcessError:
              result = subprocess.run(
                  ['git', 'ls-files', '*.md', ':!README.md'],
                  capture_output=True, text=True, check=True
              )
              changed_files = result.stdout.strip().split('\n')

          changed_files = [f for f in changed_files if f and os.path.isfile(f)]

          if not changed_files:
              print("No markdown files to process.")
              exit(0)

          print(f"Converting {len(changed_files)} file(s):")
          for md_file in changed_files:
              pdf_file = md_file.replace('.md', '.pdf')
              print(f"  Converting {md_file} -> {pdf_file}")
              
              # Read and preprocess Obsidian markdown
              with open(md_file, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # Convert Obsidian wikilinks [[link]] or [[link|alias]] to standard markdown
              content = re.sub(r'\[\[([^\]|]+)\|([^\]]+)\]\]', r'[\2](\1)', content)
              content = re.sub(r'\[\[([^\]]+)\]\]', r'[\1](\1)', content)
              
              # Convert highlights ==text== to bold
              content = re.sub(r'==([^=]+)==', r'**\1**', content)
              
              # Remove embeds ![[image]] (pandoc can't handle them easily)
              content = re.sub(r'!\[\[([^\]]+)\]\]', r'*[Image: \1]*', content)
              
              # Save preprocessed file
              temp_file = md_file + '.tmp'
              with open(temp_file, 'w', encoding='utf-8') as f:
                  f.write(content)
              
              # Convert with pandoc
              subprocess.run([
                  'pandoc', temp_file,
                  '-o', pdf_file,
                  '--pdf-engine=pdflatex',
                  '-V', 'geometry:margin=1in'
              ], check=True)
              
              # Clean up temp file
              os.remove(temp_file)
              print(f"  âœ“ Created {pdf_file}")
          EOF

      - name: Commit PDFs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add '*.pdf'
          if git diff --cached --quiet; then
            echo "No PDF changes to commit."
            exit 0
          fi
          git commit -m "Auto-generate PDFs from markdown"
          git push

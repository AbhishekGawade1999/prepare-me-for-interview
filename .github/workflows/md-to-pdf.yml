name: Markdown -> PDF
on:
  push:
    branches:
      - main
    paths:
      - '**/*.md'

permissions:
  contents: write

jobs:
  convert-md-to-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install md-to-pdf with GitHub styling
        run: |
          npm install -g md-to-pdf
          npm install -g github-markdown-css

      - name: Create PDF style configuration
        run: |
          cat > pdf-config.json << 'EOF'
          {
            "stylesheet": "https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css",
            "body_class": "markdown-body",
            "pdf_options": {
              "format": "A4",
              "margin": {
                "top": "20mm",
                "right": "20mm",
                "bottom": "20mm",
                "left": "20mm"
              },
              "printBackground": true
            },
            "stylesheet_encoding": "utf-8"
          }
          EOF

      - name: Find and convert Markdown files to PDF
        run: |
          # Find all .md files excluding README files
          find . -type f -name "*.md" ! -name "README*.md" ! -name "readme*.md" ! -path "*/node_modules/*" ! -path "*/.git/*" | while read -r file; do
            echo "Converting: $file"
            # Get the directory and filename
            dir=$(dirname "$file")
            filename=$(basename "$file" .md)
            
            # Create a temporary HTML wrapper for better GitHub styling
            cat > "/tmp/temp_wrapper.html" << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css">
            <style>
              .markdown-body {
                box-sizing: border-box;
                min-width: 200px;
                max-width: 980px;
                margin: 0 auto;
                padding: 45px;
              }
              @media print {
                .markdown-body {
                  padding: 20px;
                }
              }
              /* Ensure code blocks have proper styling */
              .markdown-body pre {
                background-color: #f6f8fa;
                border-radius: 6px;
                padding: 16px;
              }
              .markdown-body code {
                background-color: rgba(175, 184, 193, 0.2);
                padding: 0.2em 0.4em;
                border-radius: 6px;
              }
            </style>
          </head>
          <body class="markdown-body">
          HTMLEOF
            
            # Convert markdown to HTML and append
            npx marked "$file" >> "/tmp/temp_wrapper.html"
            
            echo "</body></html>" >> "/tmp/temp_wrapper.html"
            
            # Convert HTML to PDF using puppeteer (via md-to-pdf alternative)
            npx md-to-pdf "$file" --config-file pdf-config.json --output "$dir/$filename.pdf" || {
              echo "Falling back to alternative conversion method"
              npx markdown-pdf "$file" -o "$dir/$filename.pdf" 2>/dev/null || {
                # Final fallback using pandoc if available
                echo "Using direct conversion"
                cat > "/tmp/convert_$filename.md" << 'MDEOF'
          <style>
          body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; line-height: 1.6; color: #24292e; padding: 20px; }
          pre { background-color: #f6f8fa; padding: 16px; border-radius: 6px; overflow: auto; }
          code { background-color: rgba(175, 184, 193, 0.2); padding: 0.2em 0.4em; border-radius: 6px; font-family: 'Consolas', 'Monaco', monospace; }
          </style>
          MDEOF
                cat "$file" >> "/tmp/convert_$filename.md"
                md-to-pdf "/tmp/convert_$filename.md" --output "$dir/$filename.pdf"
              }
            }
            
            if [ -f "$dir/$filename.pdf" ]; then
              echo "✓ Created: $dir/$filename.pdf"
            else
              echo "✗ Failed to create: $dir/$filename.pdf"
            fi
          done

      - name: Commit PDF files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add all PDF files
          git add **/*.pdf
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No PDF changes to commit"
          else
            git commit -m "Auto-generate PDFs from Markdown files [skip ci]"
            git push
          fi

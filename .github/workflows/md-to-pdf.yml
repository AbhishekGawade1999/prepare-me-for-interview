name: Convert changed Markdown to PDF

on:
  push:
    branches:
      - main
    paths:
      - '**/*.md'

permissions:
  contents: write

jobs:
  md-to-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-latex-recommended

      - name: Determine changed markdown files (exclude README.md)
        id: changed
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # If this is the initial commit, list all md files
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            git ls-files '*.md' > all_md.txt || true
          else
            git diff --name-only "$BEFORE" "$AFTER" -- '*.md' > all_md.txt || true
          fi

          # Filter out README.md (case-insensitive) anywhere in the repo
          grep -v -Ei '(^|/)(readme)\.md$' all_md.txt > changed_md_filtered.txt || true

          # Prepare a pipe-separated list for output (empty if none)
          FILES=$(awk '{printf "%s|", $0}' changed_md_filtered.txt || true)
          # Trim trailing pipe
          FILES=${FILES%|}

          echo "files=$FILES" >> $GITHUB_OUTPUT

      - name: Convert changed markdown to PDF and commit if different
        if: ${{ steps.changed.outputs.files != '' }}
        run: |
          set -euo pipefail
          IFS='|' read -r -a FILES <<< "${{ steps.changed.outputs.files }}"
          CHANGED=false

          for md in "${FILES[@]}"; do
            [ -z "$md" ] && continue

            pdf="${md%.md}.pdf"
            mkdir -p "$(dirname "$pdf")"

            # Convert using pandoc (adjust options for Obsidian specifics if needed)
            pandoc "$md" -o "$pdf" --pdf-engine=xelatex || {
              echo "pandoc failed for $md"
              exit 1
            }

            # If PDF not tracked yet, add it
            if ! git ls-files --error-unmatch "$pdf" >/dev/null 2>&1; then
              git add "$pdf"
              CHANGED=true
              echo "Staged new PDF: $pdf"
            else
              # Extract the version from HEAD to a temp file (if exists) and compare
              TMP_OLD="/tmp/old_pdf_$(basename "$pdf")"
              if git show HEAD:"$pdf" > "$TMP_OLD" 2>/dev/null; then
                if ! cmp -s "$TMP_OLD" "$pdf"; then
                  git add "$pdf"
                  CHANGED=true
                  echo "Staged updated PDF: $pdf"
                else
                  echo "No change in PDF: $pdf"
                fi
                rm -f "$TMP_OLD"
              else
                # HEAD doesn't have the file (shouldn't happen because ls-files said tracked), but handle anyway
                git add "$pdf"
                CHANGED=true
                echo "Staged PDF (no HEAD copy): $pdf"
              fi
            fi
          done

          if [ "$CHANGED" = "true" ]; then
            git commit -m "chore: update PDFs generated from changed markdown files" || echo "nothing to commit"
            git push origin HEAD:main
          else
            echo "No PDF changes to commit"
          fi

      - name: No changed markdown files
        if: ${{ steps.changed.outputs.files == '' }}
        run: echo "No changed markdown files to process (or only README.md changed)"

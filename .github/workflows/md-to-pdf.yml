name: Markdown -> PDF (Chromium + puppeteer-core)

on:
  push:
    branches:
      - main
    paths:
      - '**/*.md'

permissions:
  contents: write

jobs:
  md-to-pdf:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine changed markdown files (exclude README.md)
        id: changed
        run: |
          set -euo pipefail
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            git ls-files '*.md' > all_md.txt || true
          else
            git diff --name-only "$BEFORE" "$AFTER" -- '*.md' > all_md.txt || true
          fi
          grep -v -Ei '(^|/)(readme)\.md$' all_md.txt > changed_md_filtered.txt || true
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          if [ -s changed_md_filtered.txt ]; then
            cat changed_md_filtered.txt >> "$GITHUB_OUTPUT"
          fi
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Install system Chromium and deps
        if: ${{ steps.changed.outputs.files != '' }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          # Try to install chromium; some images provide different package names
          sudo apt-get install -y --no-install-recommends chromium-browser chromium || true
          # Ensure /dev/shm is writable (fixes shared memory errors)
          if [ -d /dev/shm ]; then
            sudo chmod 1777 /dev/shm || true
          fi

      - name: Setup Node.js
        if: ${{ steps.changed.outputs.files != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Node packages (puppeteer-core + renderer libs)
        if: ${{ steps.changed.outputs.files != '' }}
        run: |
          set -euo pipefail
          npm init -y
          # puppeteer-core avoids downloading Chromium; we'll use system chromium
          npm install --no-audit --no-fund puppeteer-core markdown-it markdown-it-footnote markdown-it-deflist markdown-it-abbr markdown-it-attrs highlight.js

      - name: Convert changed markdown to PDF (puppeteer-core)
        if: ${{ steps.changed.outputs.files != '' }}
        env:
          FILES: ${{ steps.changed.outputs.files }}
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          cat > convert-md-to-pdf.js <<'NODE'
          const fs = require('fs');
          const path = require('path');
          const { execSync } = require('child_process');
          const puppeteer = require('puppeteer-core');
          const MarkdownIt = require('markdown-it');
          const md = MarkdownIt({ html: true, linkify: true, typographer: true })
            .use(require('markdown-it-footnote'))
            .use(require('markdown-it-deflist'))
            .use(require('markdown-it-abbr'))
            .use(require('markdown-it-attrs'));
          const hljs = require('highlight.js');

          md.set({
            highlight: function (str, lang) {
              try {
                if (lang && hljs.getLanguage(lang)) {
                  return '<pre class="hljs"><code>' +
                         hljs.highlight(str, { language: lang, ignoreIllegals: true }).value +
                         '</code></pre>';
                }
              } catch (e) {}
              return '<pre class="hljs"><code>' + md.utils.escapeHtml(str) + '</code></pre>';
            }
          });

          const filesEnv = process.env.FILES || '';
          const files = filesEnv.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
          if (files.length === 0) {
            console.log('No files to process');
            process.exit(0);
          }

          // Detect system chromium executable
          const candidates = [
            '/usr/bin/chromium-browser',
            '/usr/bin/chromium',
            '/snap/bin/chromium',
            '/usr/bin/google-chrome-stable'
          ];
          let executablePath = null;
          for (const p of candidates) {
            if (fs.existsSync(p)) { executablePath = p; break; }
          }
          if (!executablePath) {
            console.error('No system Chromium found. Ensure chromium is installed on the runner.');
            process.exit(2);
          }
          console.log('Using Chromium at', executablePath);

          // Load optional Obsidian CSS
          let themeCss = '';
          const themePath = path.join(process.cwd(), '.obsidian', 'export.css');
          if (fs.existsSync(themePath)) {
            themeCss = fs.readFileSync(themePath, 'utf8');
            console.log('Using .obsidian/export.css for styling');
          } else {
            themeCss = `
            body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 28px; color: #222; background: #fff; }
            .markdown-body { max-width: 980px; margin: 0 auto; }
            pre { background: #f6f8fa; padding: 12px; border-radius: 6px; overflow: auto; }
            code { font-family: "SFMono-Regular", Menlo, Monaco, "Roboto Mono", "Courier New", monospace; }
            .hljs { background: transparent; }
            `;
          }

          (async () => {
            const browser = await puppeteer.launch({
              executablePath,
              args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage', '--disable-gpu'],
              headless: true
            });

            let anyStaged = false;

            for (const mdPath of files) {
              try {
                console.log('Processing', mdPath);
                const markdown = fs.readFileSync(mdPath, 'utf8');
                const htmlBody = md.render(markdown);
                const html = `<!doctype html>
                <html>
                  <head>
                    <meta charset="utf-8">
                    <meta name="viewport" content="width=device-width,initial-scale=1">
                    <title>${path.basename(mdPath)}</title>
                    <style>${themeCss}</style>
                  </head>
                  <body>
                    <article class="markdown-body">${htmlBody}</article>
                  </body>
                </html>`;

                const page = await browser.newPage();
                await page.setContent(html, { waitUntil: 'networkidle0' });
                const pdfPath = mdPath.replace(/\.md$/i, '.pdf');
                await page.pdf({ path: pdfPath, format: 'A4', printBackground: true, landscape: false, margin: { top: '20mm', bottom: '20mm', left: '15mm', right: '15mm' } });
                await page.close();
                console.log('Wrote PDF:', pdfPath);

                // Compare with HEAD version and stage if different
                let needsAdd = false;
                try {
                  const tmpOld = `/tmp/old_${path.basename(pdfPath)}`;
                  try { execSync(`git show HEAD:"${pdfPath}" > "${tmpOld}" 2>/dev/null || true`); } catch (e) {}
                  if (!fs.existsSync(tmpOld)) {
                    needsAdd = true;
                  } else {
                    const oldBuf = fs.readFileSync(tmpOld);
                    const newBuf = fs.readFileSync(pdfPath);
                    if (!oldBuf.equals(newBuf)) needsAdd = true;
                    fs.unlinkSync(tmpOld);
                  }
                } catch (e) {
                  needsAdd = true;
                }

                if (needsAdd) {
                  execSync(`git add "${pdfPath}"`);
                  anyStaged = true;
                  console.log('Staged', pdfPath);
                } else {
                  console.log('No change for', pdfPath);
                }

              } catch (err) {
                console.error('Error processing', mdPath, err && err.stack ? err.stack : err);
              }
            }

            await browser.close();

            if (anyStaged) {
              try {
                execSync('git commit -m "chore: update PDFs generated from changed markdown files" || true', { stdio: 'inherit' });
                execSync('git push origin HEAD:main', { stdio: 'inherit' });
                console.log('Committed and pushed updated PDFs');
              } catch (err) {
                console.error('Commit/push failed', err && err.message ? err.message : err);
                process.exit(1);
              }
            } else {
              console.log('No PDF changes to commit');
            }
          })().catch(err => {
            console.error(err);
            process.exit(1);
          });
          NODE

          node convert-md-to-pdf.js

      - name: No changed markdown files
        if: ${{ steps.changed.outputs.files == '' }}
        run: echo "No changed markdown files to process (or only README.md changed)"
